# MySQL ä¸ MongoDB æ•°æ®åŒæ­¥æ–¹æ¡ˆæ€»ç»“

## ğŸ¯ æ ¸å¿ƒç­”æ¡ˆ

### Q1: å¦‚ä½•å®šä¹‰ä¸¤ä¸ªæ•°æ®åº“çš„èŒè´£èŒƒå›´ï¼Ÿ

**ç®€å•è®°å¿†æ³•ï¼š**
```
MySQL  = å…³ç³» + ç»“æ„ + äº‹åŠ¡
MongoDB = å†…å®¹ + æµ·é‡ + çµæ´»
```

**è¯¦ç»†åˆ’åˆ†ï¼š**

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | æ ¸å¿ƒåŸå›  |
|---------|---------|---------|
| ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯ | MySQL | éœ€è¦å”¯ä¸€çº¦æŸã€å¤æ‚æŸ¥è¯¢ |
| ğŸ‘¥ å¥½å‹å…³ç³» | MySQL | å…¸å‹çš„å¤šå¯¹å¤šå…³ç³» |
| ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç¾¤ç»„ä¿¡æ¯ | MySQL | ä¸€å¯¹å¤šå…³ç³»ã€éœ€è¦ç»Ÿè®¡ |
| ğŸ“‹ ä¼šè¯åˆ—è¡¨ | MySQL | éœ€è¦æ’åºã€ç»Ÿè®¡æœªè¯»æ•° |
| ğŸ’¬ æ¶ˆæ¯å†…å®¹ | MongoDB | æµ·é‡æ•°æ®ã€é«˜å†™å…¥ã€çµæ´»Schema |
| ğŸ“¦ ç¦»çº¿æ¶ˆæ¯ | MongoDB | ä¸´æ—¶æ•°æ®ã€æ•°ç»„ç»“æ„ |

---

### Q2: å¦‚ä½•ä¿æŒä¸¤ä¸ªæ•°æ®åº“åŒæ­¥ï¼Ÿ

**æ ¸å¿ƒç­”æ¡ˆï¼šä¸éœ€è¦å®Œå…¨åŒæ­¥ï¼**

ä¸¤ä¸ªæ•°æ®åº“å­˜å‚¨çš„æ˜¯**ä¸åŒç»´åº¦**çš„æ•°æ®ï¼š
- MySQL å­˜å‚¨**å…³ç³»å’Œæ‘˜è¦**
- MongoDB å­˜å‚¨**å®Œæ•´å†…å®¹**

**åŒæ­¥ç­–ç•¥ï¼š**
```
å‘é€æ¶ˆæ¯æ—¶ï¼š
  1. ä¿å­˜å®Œæ•´æ¶ˆæ¯åˆ° MongoDB âœ…
  2. ä¿å­˜æ¶ˆæ¯æ‘˜è¦åˆ° MySQL âœ…
  3. å‘é€åˆ° RocketMQ âœ…

æŸ¥è¯¢æ—¶ï¼š
  - æŸ¥ä¼šè¯åˆ—è¡¨ â†’ MySQL
  - æŸ¥æ¶ˆæ¯å†…å®¹ â†’ MongoDB
```

---

## ğŸ’¡ å®é™…å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šåº”ç”¨å±‚åŒæ­¥ï¼ˆæ¨èï¼‰

```java
@Service
public class MessageServiceImpl {
    
    @Autowired
    private MessageRepository messageRepository;  // MongoDB
    
    @Autowired
    private ConversationService conversationService;  // MySQL
    
    @Override
    public MessageVO sendMessage(Long senderId, MessageSendDTO sendDTO) {
        // æ­¥éª¤1: ä¿å­˜åˆ° MongoDBï¼ˆä¸»å­˜å‚¨ï¼‰
        Message message = buildMessage(sendDTO);
        Message saved = messageRepository.save(message).block();
        String messageId = saved.getId();
        
        try {
            // æ­¥éª¤2: æ›´æ–° MySQL ä¼šè¯è¡¨ï¼ˆæ‘˜è¦ä¿¡æ¯ï¼‰
            conversationService.updateConversation(
                senderId,           // ä¼šè¯æ‰€æœ‰è€…
                receiverId,         // å¯¹æ–¹ID
                0,                  // å•èŠ
                messageId,          // MongoDBæ¶ˆæ¯ID
                content,            // æ¶ˆæ¯å†…å®¹ï¼ˆæˆªæ–­ï¼‰
                sendTime,           // æ¶ˆæ¯æ—¶é—´
                false               // å‘é€è€…ä¸å¢åŠ æœªè¯»æ•°
            );
            
            conversationService.updateConversation(
                receiverId,         // æ¥æ”¶è€…
                senderId,           // å‘é€è€…ID
                0,                  // å•èŠ
                messageId,          // MongoDBæ¶ˆæ¯ID
                content,            // æ¶ˆæ¯å†…å®¹
                sendTime,           // æ¶ˆæ¯æ—¶é—´
                true                // æ¥æ”¶è€…å¢åŠ æœªè¯»æ•°
            );
            
        } catch (Exception e) {
            // å¤±è´¥ä¸å½±å“æ¶ˆæ¯å‘é€ï¼ˆMongoDBå·²ä¿å­˜ï¼‰
            log.error("æ›´æ–°ä¼šè¯è¡¨å¤±è´¥", e);
        }
        
        // æ­¥éª¤3: å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        messageProducer.sendMessage("im-message-topic", saved);
        
        return convertToVO(saved);
    }
}
```

---

## ğŸ”— å…³é”®ï¼šä¼šè¯è¡¨ï¼ˆConversationï¼‰

### ä¼šè¯è¡¨æ˜¯è¿æ¥ä¸¤ä¸ªæ•°æ®åº“çš„æ¡¥æ¢

```sql
CREATE TABLE `conversation` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `conversation_id` varchar(64) NOT NULL,
  `owner_id` bigint(20) NOT NULL,
  `target_id` bigint(20) NOT NULL,
  `unread_count` int(11) DEFAULT '0',
  
  -- å…³é”®ï¼šè¿æ¥åˆ° MongoDB
  `last_message_id` varchar(64),      -- MongoDB çš„ _id
  `last_message_content` varchar(500), -- æ¶ˆæ¯å†…å®¹ï¼ˆå†—ä½™ï¼‰
  `last_message_time` datetime,        -- æ¶ˆæ¯æ—¶é—´
  
  PRIMARY KEY (`id`),
  KEY `idx_owner_time` (`owner_id`, `last_message_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**å·¥ä½œåŸç†ï¼š**
```
ç”¨æˆ·Aå‘æ¶ˆæ¯ç»™ç”¨æˆ·B
  â†“
ä¿å­˜åˆ° MongoDB
  è¿”å› messageId = "507f1f77bcf86cd799439011"
  â†“
æ›´æ–° MySQL conversation è¡¨
  UPDATE conversation SET
    last_message_id = "507f1f77bcf86cd799439011",  â† å­˜å‚¨MongoDB ID
    last_message_content = "ä½ å¥½",                  â† å†—ä½™å­˜å‚¨
    last_message_time = NOW(),
    unread_count = unread_count + 1
  WHERE owner_id = B AND target_id = A
  â†“
ç”¨æˆ·BæŸ¥è¯¢ä¼šè¯åˆ—è¡¨
  SELECT * FROM conversation WHERE owner_id = B
  â†“
ç”¨æˆ·Bç‚¹å‡»ä¼šè¯ï¼ŒæŸ¥è¯¢å†å²æ¶ˆæ¯
  ä» MongoDB æŸ¥è¯¢ï¼š
  db.message.find({ 
    $or: [
      { senderId: A, receiverId: B },
      { senderId: B, receiverId: A }
    ]
  }).sort({ sendTime: -1 })
```

---

## ğŸ“Š æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·å‘é€æ¶ˆæ¯                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageService.sendMessage()                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. ä¿å­˜åˆ° MongoDB (message é›†åˆ)                   â”‚ â”‚
â”‚  â”‚    â†’ è¿”å› messageId                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 2. æ›´æ–° MySQL (conversation è¡¨)                    â”‚ â”‚
â”‚  â”‚    â†’ å­˜å‚¨ messageId + æ¶ˆæ¯æ‘˜è¦                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 3. å‘é€åˆ° RocketMQ                                 â”‚ â”‚
â”‚  â”‚    â†’ å¼‚æ­¥æ¨é€ç»™æ¥æ”¶è€…                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æŸ¥è¯¢ä¼šè¯åˆ—è¡¨                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä» MySQL æŸ¥è¯¢ conversation è¡¨                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SELECT * FROM conversation                         â”‚ â”‚
â”‚  â”‚ WHERE owner_id = ?                                 â”‚ â”‚
â”‚  â”‚ ORDER BY last_message_time DESC                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  è¿”å›ï¼š                                                  â”‚
â”‚  - ä¼šè¯åˆ—è¡¨                                              â”‚
â”‚  - æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹ï¼ˆå†—ä½™å­—æ®µï¼‰                           â”‚
â”‚  - æœªè¯»æ¶ˆæ¯æ•°                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ç”¨æˆ·ç‚¹å‡»ä¼šè¯ï¼ŒæŸ¥è¯¢å†å²æ¶ˆæ¯                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä» MongoDB æŸ¥è¯¢ message é›†åˆ                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ db.message.find({                                  â”‚ â”‚
â”‚  â”‚   $or: [                                           â”‚ â”‚
â”‚  â”‚     { senderId: A, receiverId: B },                â”‚ â”‚
â”‚  â”‚     { senderId: B, receiverId: A }                 â”‚ â”‚
â”‚  â”‚   ]                                                â”‚ â”‚
â”‚  â”‚ }).sort({ sendTime: -1 }).limit(20)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  è¿”å›ï¼šå®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… æ•°æ®ä¸€è‡´æ€§ä¿è¯

### 1. æœ€ç»ˆä¸€è‡´æ€§ï¼ˆæ¨èï¼‰

```
åŸåˆ™ï¼š
âœ… MongoDB æ˜¯æ¶ˆæ¯çš„ä¸»å­˜å‚¨ï¼ˆSource of Truthï¼‰
âœ… MySQL å­˜å‚¨çš„æ˜¯æ‘˜è¦ä¿¡æ¯ï¼ˆå¯ä»¥é‡å»ºï¼‰
âœ… å…è®¸çŸ­æš‚çš„ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä¼šä¸€è‡´
```

### 2. å¹‚ç­‰æ€§è®¾è®¡

```sql
-- æ›´æ–°ä¼šè¯è¡¨æ—¶ï¼Œåªæœ‰å½“æ–°æ¶ˆæ¯æ—¶é—´æ›´æ™šæ—¶æ‰æ›´æ–°
UPDATE conversation SET
  last_message_id = ?,
  last_message_time = ?,
  unread_count = unread_count + 1
WHERE owner_id = ? AND target_id = ?
  AND (last_message_time IS NULL OR last_message_time <= ?)
```

### 3. å¤±è´¥å¤„ç†

```java
try {
    // æ›´æ–° MySQL
    conversationService.updateConversation(...);
} catch (Exception e) {
    // è®°å½•å¤±è´¥æ—¥å¿—
    log.error("æ›´æ–°ä¼šè¯è¡¨å¤±è´¥", e);
    
    // ä¸å½±å“æ¶ˆæ¯å‘é€ï¼ˆMongoDB å·²ä¿å­˜æˆåŠŸï¼‰
    // å¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡è¡¥å¿
}
```

### 4. è¡¥å¿æœºåˆ¶ï¼ˆå¯é€‰ï¼‰

```java
@Scheduled(cron = "0 0 * * * ?")  // æ¯å°æ—¶æ‰§è¡Œ
public void syncRecentMessages() {
    // 1. ä» MongoDB æŸ¥è¯¢æœ€è¿‘1å°æ—¶çš„æ¶ˆæ¯
    // 2. æ£€æŸ¥å¯¹åº”çš„ä¼šè¯è¡¨æ˜¯å¦å·²æ›´æ–°
    // 3. å¦‚æœæœªæ›´æ–°ï¼Œæ‰§è¡Œè¡¥å¿
}
```

---

## ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šç”¨æˆ·Aå‘é€æ¶ˆæ¯ç»™ç”¨æˆ·B

```java
// 1. å‰ç«¯è°ƒç”¨
POST /api/message/send
Body: {
  messageType: 1,      // å•èŠ
  contentType: 1,      // æ–‡æœ¬
  receiverId: 456,
  content: "ä½ å¥½"
}

// 2. åç«¯å¤„ç†
MessageService.sendMessage(123, sendDTO)
  â†’ MongoDB.save(message)  // è¿”å› messageId
  â†’ MySQL.updateConversation(123, 456, messageId, "ä½ å¥½", false)
  â†’ MySQL.updateConversation(456, 123, messageId, "ä½ å¥½", true)
  â†’ RocketMQ.send(message)

// 3. æ•°æ®å­˜å‚¨ç»“æœ
MongoDB message é›†åˆï¼š
{
  _id: "507f1f77bcf86cd799439011",
  messageType: 1,
  senderId: 123,
  receiverId: 456,
  content: "ä½ å¥½",
  sendTime: "2024-12-03T10:00:00Z"
}

MySQL conversation è¡¨ï¼ˆç”¨æˆ·Aï¼‰ï¼š
{
  conversation_id: "conv_123_456",
  owner_id: 123,
  target_id: 456,
  last_message_id: "507f1f77bcf86cd799439011",  â† MongoDB ID
  last_message_content: "ä½ å¥½",
  last_message_time: "2024-12-03 10:00:00",
  unread_count: 0  â† å‘é€è€…ä¸å¢åŠ 
}

MySQL conversation è¡¨ï¼ˆç”¨æˆ·Bï¼‰ï¼š
{
  conversation_id: "conv_123_456",
  owner_id: 456,
  target_id: 123,
  last_message_id: "507f1f77bcf86cd799439011",  â† åŒä¸€ä¸ª MongoDB ID
  last_message_content: "ä½ å¥½",
  last_message_time: "2024-12-03 10:00:00",
  unread_count: 1  â† æ¥æ”¶è€…å¢åŠ 
}
```

### åœºæ™¯2ï¼šç”¨æˆ·BæŸ¥è¯¢ä¼šè¯åˆ—è¡¨

```java
// 1. å‰ç«¯è°ƒç”¨
GET /api/conversation/list

// 2. åç«¯å¤„ç†
ConversationService.getUserConversations(456)
  â†’ SELECT * FROM conversation 
    WHERE owner_id = 456 
    ORDER BY last_message_time DESC

// 3. è¿”å›ç»“æœ
[
  {
    conversationId: "conv_123_456",
    targetId: 123,
    targetName: "ç”¨æˆ·A",
    targetAvatar: "http://...",
    lastMessageContent: "ä½ å¥½",  â† ç›´æ¥ä» MySQL è¯»å–
    lastMessageTime: "2024-12-03 10:00:00",
    unreadCount: 1
  }
]
```

### åœºæ™¯3ï¼šç”¨æˆ·Bç‚¹å‡»ä¼šè¯ï¼ŒæŸ¥è¯¢å†å²æ¶ˆæ¯

```java
// 1. å‰ç«¯è°ƒç”¨
GET /api/message/chat/123?pageNum=1&pageSize=20

// 2. åç«¯å¤„ç†
MessageService.getChatHistory(456, 123, 1, 20)
  â†’ MongoDB.find({
      $or: [
        { senderId: 123, receiverId: 456 },
        { senderId: 456, receiverId: 123 }
      ]
    }).sort({ sendTime: -1 }).limit(20)

// 3. è¿”å›å®Œæ•´æ¶ˆæ¯åˆ—è¡¨ï¼ˆä» MongoDBï¼‰
[
  {
    id: "507f1f77bcf86cd799439011",
    senderId: 123,
    receiverId: 456,
    content: "ä½ å¥½",
    sendTime: "2024-12-03T10:00:00Z"
  },
  ...
]

// 4. åŒæ—¶æ¸…ç©ºæœªè¯»æ•°ï¼ˆæ›´æ–° MySQLï¼‰
ConversationService.clearUnreadCount("conv_123_456", 456)
  â†’ UPDATE conversation SET unread_count = 0
    WHERE conversation_id = "conv_123_456" AND owner_id = 456
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **èŒè´£æ˜ç¡®**
   - MySQLï¼šå…³ç³»ã€ç»“æ„ã€æ‘˜è¦
   - MongoDBï¼šå†…å®¹ã€æµ·é‡ã€çµæ´»

2. **ä¸éœ€è¦å®Œå…¨åŒæ­¥**
   - ä¸¤ä¸ªæ•°æ®åº“å­˜å‚¨ä¸åŒç»´åº¦çš„æ•°æ®
   - é€šè¿‡ä¼šè¯è¡¨ï¼ˆconversationï¼‰è¿æ¥

3. **åº”ç”¨å±‚åŒæ­¥**
   - å‘é€æ¶ˆæ¯æ—¶åŒæ—¶æ“ä½œä¸¤ä¸ªæ•°æ®åº“
   - ç®€å•ç›´æ¥ï¼Œæ˜“äºç†è§£

4. **æœ€ç»ˆä¸€è‡´æ€§**
   - MongoDB ä¸ºä¸»ï¼ˆSource of Truthï¼‰
   - MySQL ä¸ºè¾…ï¼ˆå¯é‡å»ºï¼‰
   - å¤±è´¥ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½

5. **æŸ¥è¯¢ç­–ç•¥**
   - ä¼šè¯åˆ—è¡¨ â†’ MySQL
   - æ¶ˆæ¯å†…å®¹ â†’ MongoDB

### å®ç°å»ºè®®

```
âœ… ä½¿ç”¨åº”ç”¨å±‚åŒæ­¥ï¼ˆæ–¹æ¡ˆ1ï¼‰
âœ… æ·»åŠ å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—
âœ… å¯é€‰ï¼šæ·»åŠ å®šæ—¶è¡¥å¿ä»»åŠ¡
âœ… ä¿è¯ MongoDB æ“ä½œæˆåŠŸ
âœ… MySQL å¤±è´¥ä¸å½±å“æ¶ˆæ¯å‘é€
```

è¿™æ ·çš„è®¾è®¡æ—¢æ»¡è¶³æ¯•è®¾è¦æ±‚ï¼Œåˆå…·æœ‰å®é™…é¡¹ç›®çš„å‚è€ƒä»·å€¼ï¼ğŸ‰
