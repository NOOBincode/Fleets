# Fleets 技术决策记录

## 决策1：可观测性技术栈选型

**日期**：2025-01-13  
**状态**：已决策  
**决策者**：项目负责人

### 背景

项目最初定位为本科毕业设计，考虑采用ELK技术栈进行日志管理。但经过讨论，项目定位调整为：
- 短期目标：完成毕业设计（2025年6月答辩）
- 长期目标：个人长期维护项目，与监控项目、资源调配项目集成

### 候选方案

#### 方案A：ELK (Elasticsearch + Logstash + Kibana)
**优势**：
- 功能强大，企业级方案
- 社区成熟，文档丰富

**劣势**：
- 资源占用大（Elasticsearch至少2GB内存）
- 配置复杂，学习成本高
- 对毕业设计来说过度设计
- 影响核心功能开发时间

#### 方案B：Logback（仅日志）
**优势**：
- 零配置，开箱即用
- 轻量级，不占用额外资源
- 足够满足毕业设计需求

**劣势**：
- 无可视化界面
- 无指标监控
- 不适合长期维护

#### 方案C：Fluentd + Prometheus + Grafana + Loki（推荐）
**优势**：
- 云原生标准（CNCF项目）
- 资源占用低（600MB vs ELK的3GB）
- 统一可视化界面（Grafana）
- 易于与其他项目集成
- 支持指标监控 + 日志聚合
- 技术栈现代化，答辩加分

**劣势**：
- 需要额外部署时间（约8小时）
- 学习曲线（但比ELK简单）

### 最终决策

**选择方案C：Fluentd + Prometheus + Grafana + Loki**

### 决策理由

1. **项目定位升级**：从毕业设计升级为长期维护项目
2. **多项目集成**：需要与监控项目、资源调配项目打通
3. **资源效率**：600MB内存占用，适合个人服务器
4. **技术先进性**：云原生技术栈，符合行业趋势
5. **答辩价值**：展示现代化技术栈，提升项目档次

### 实施计划

#### 阶段1：毕业设计阶段（现在-2025年6月）
- **优先级**：低（核心功能优先）
- **工作内容**：
  - ✅ 准备配置文件（已完成）
  - ⏳ 答辩前2周部署基础监控
  - ⏳ 答辩时展示监控大屏
- **工作量**：8小时

#### 阶段2：长期维护阶段（2025年6月后）
- **优先级**：高
- **工作内容**：
  - 补充自定义业务指标
  - 配置告警规则（钉钉/企业微信）
  - 与监控项目集成（Prometheus联邦）
  - 与资源调配项目集成（自动扩缩容）
  - 完善Dashboard
- **工作量**：20小时

### 技术细节

#### 架构图

```
Grafana (统一可视化)
   ↓
Prometheus (指标) + Loki (日志)
   ↓
Fleets Application
```

#### 资源占用

| 组件 | 内存 | CPU | 磁盘 |
|-----|------|-----|------|
| Prometheus | 200MB | 0.1核 | 10GB |
| Loki | 150MB | 0.1核 | 5GB |
| Fluentd | 100MB | 0.1核 | 1GB |
| Grafana | 150MB | 0.1核 | 1GB |
| **总计** | **600MB** | **0.4核** | **17GB** |

#### 监控指标

**系统指标**（自动采集）：
- JVM内存、GC、线程
- HTTP请求数、响应时间
- 数据库连接池
- Redis连接

**业务指标**（自定义）：
- 用户注册/登录数
- 在线用户数
- 消息发送量
- 好友添加量
- WebSocket连接数

### 与其他项目集成

#### 1. 监控项目集成
- Prometheus联邦：监控项目从Fleets的Prometheus拉取指标
- 统一Grafana：所有项目共用一个Grafana实例

#### 2. 资源调配项目集成
- 根据Fleets的负载指标（在线用户数、CPU、内存）自动扩缩容
- 通过Prometheus API获取实时指标

### 风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|-----|------|------|---------|
| 部署时间超预期 | 影响核心功能开发 | 低 | 配置文件已准备，答辩前再部署 |
| 资源占用过高 | 本地开发机器卡顿 | 低 | 可选择性启动组件 |
| 学习成本高 | 延误答辩准备 | 低 | 文档齐全，社区活跃 |

### 参考文档

- [完整技术方案](./OBSERVABILITY_STACK.md)
- [快速启动指南](./OBSERVABILITY_QUICK_START.md)
- [ELK对比分析](./ELK_DEPLOYMENT_RECOMMENDATION.md)
- [部署指南](../docker/observability/README.md)

---

## 决策2：测试策略

**日期**：2025-01-13  
**状态**：已实施  

### 背景

项目初期仅使用Postman进行接口测试，不够专业，需要完善测试体系。

### 最终方案

**混合测试方案**：
- 单元测试：JUnit 5 + Mockito（80%占比）
- 集成测试：Spring Boot Test（15%占比）
- 接口测试：Postman + REST Assured（3%占比）
- 性能测试：Locust + JMeter（2%占比）

### 实施状态

- ✅ 测试框架配置完成
- ✅ 用户模块单元测试（15个用例）
- ✅ 用户模块集成测试（7个用例）
- ✅ Locust性能测试脚本
- ⏳ 其他模块测试待补充

---

## 决策3：好友关系验证流程

**日期**：2025-01-13  
**状态**：已实施  

### 背景

初始设计中，好友添加是直接建立关系，缺少验证流程，不符合实际场景。

### 最终方案

**好友验证流程**：
1. 用户A发送好友请求（status=0，待确认）
2. 用户B接受请求（status=1，已确认）
3. 用户B拒绝请求（status=2，已拒绝）

**状态定义**：
- 0：待确认
- 1：已确认
- 2：已拒绝
- 3：已拉黑

### 实施状态

- ✅ 封装`createFriendship()`方法消除代码重复
- ✅ 新增`acceptFriendRequest()`方法
- ✅ 新增`rejectFriendRequest()`方法
- ✅ 新增`getPendingFriendRequests()`方法
- ✅ 创建工作流文档

---

## 决策4：Mailbox模块设计

**日期**：2025-01-13  
**状态**：骨架完成  

### 背景

初始设计缺少Mailbox组件，消息流转不完整。

### 最终方案

**Mailbox作用**：
- 消息序列号管理（保证消息顺序）
- 离线消息存储
- 消息可靠性保证
- 多端同步支持

### 实施状态

- ✅ 设计文档完成
- ✅ 实体类、Repository、Service骨架
- ✅ Controller接口（8个REST接口）
- ✅ MongoDB索引脚本
- ⏳ 10个业务方法待实现

---

## 决策历史

| 日期 | 决策 | 状态 |
|-----|------|------|
| 2025-01-13 | 可观测性技术栈：Fluentd + Prometheus + Grafana | 已决策 |
| 2025-01-13 | 测试策略：混合测试方案 | 已实施 |
| 2025-01-13 | 好友关系验证流程 | 已实施 |
| 2025-01-13 | Mailbox模块设计 | 骨架完成 |

---

## 下一步决策

### 待决策事项

1. **前端技术栈选型**
   - 候选：Vue 3 + TypeScript / React + TypeScript
   - 优先级：中
   - 决策时间：2025年3月

2. **部署方案**
   - 候选：Docker Compose / Kubernetes / 云服务
   - 优先级：低
   - 决策时间：2025年5月

3. **消息加密方案**
   - 候选：端到端加密 / 传输层加密
   - 优先级：低
   - 决策时间：待定

---

## 决策原则

1. **优先核心功能**：答辩前专注核心业务实现
2. **技术适度先进**：采用成熟但不过时的技术
3. **资源效率优先**：考虑个人服务器资源限制
4. **长期可维护**：选择社区活跃、文档齐全的技术
5. **答辩价值导向**：技术选型要能在答辩中展示价值
