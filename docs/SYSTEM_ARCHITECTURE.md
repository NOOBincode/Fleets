# Fleets IM ç³»ç»Ÿæ¶æ„å…¨è§£æ

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

**é¡¹ç›®åç§°ï¼š** Fleets  
**é¡¹ç›®ç±»å‹ï¼š** Java å³æ—¶é€šè®¯ç³»ç»Ÿï¼ˆIMï¼‰  
**æŠ€æœ¯æ ˆï¼š** Spring Boot + WebSocket + RocketMQ + Redis + MongoDB + MySQL  
**é€‚ç”¨åœºæ™¯ï¼š** æ¯•ä¸šè®¾è®¡é¡¹ç›®

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯å±‚                                â”‚
â”‚                    Vue + Ant Design                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç½‘å…³å±‚ (OpenResty)                       â”‚
â”‚  - JWT è®¤è¯ (auth.lua)                                       â”‚
â”‚  - é™æµæ§åˆ¶ (limit.lua)                                      â”‚
â”‚  - WebSocket ä»£ç† (websocket_handler.lua)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Spring Boot)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç”¨æˆ·æ¨¡å—  â”‚  å¥½å‹æ¨¡å—  â”‚  ç¾¤ç»„æ¨¡å—  â”‚  æ¶ˆæ¯æ¨¡å—  â”‚  æ–‡ä»¶æ¨¡å—  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              è¿æ¥ç®¡ç†æ¨¡å— (WebSocket)                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸­é—´ä»¶å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  MySQL   â”‚  MongoDB â”‚  Redis   â”‚  RocketMQ            â”‚ â”‚
â”‚  â”‚  å…³ç³»æ•°æ®  â”‚  æ¶ˆæ¯å­˜å‚¨  â”‚  ç¼“å­˜    â”‚  æ¶ˆæ¯é˜Ÿåˆ—             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. ç”¨æˆ·æ¨¡å— (User Module)

**åŠŸèƒ½ï¼š** ç”¨æˆ·è´¦å·ç®¡ç†

**æ ¸å¿ƒç±»ï¼š**
- `User` - ç”¨æˆ·å®ä½“
- `UserService` - ç”¨æˆ·æœåŠ¡æ¥å£
- `UserServiceImpl` - ç”¨æˆ·æœåŠ¡å®ç°
- `UserController` - ç”¨æˆ·æ§åˆ¶å™¨
- `UserCacheService` - ç”¨æˆ·ç¼“å­˜æœåŠ¡

**ä¸»è¦åŠŸèƒ½ï¼š**
- âœ… ç”¨æˆ·æ³¨å†Œ/ç™»å½•/ç™»å‡º
- âœ… ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢/æ›´æ–°
- âœ… å¯†ç ä¿®æ”¹/é‡ç½®
- âœ… å¤´åƒä¸Šä¼ 
- âœ… ç”¨æˆ·çŠ¶æ€ç®¡ç†

**æ•°æ®å­˜å‚¨ï¼š**
- MySQL `user` è¡¨ - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- Redis - ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ã€Token ç¼“å­˜

**API ç¤ºä¾‹ï¼š**
```
POST   /api/user/register    - ç”¨æˆ·æ³¨å†Œ
POST   /api/user/login       - ç”¨æˆ·ç™»å½•
GET    /api/user/info        - è·å–ç”¨æˆ·ä¿¡æ¯
PUT    /api/user/update      - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
POST   /api/user/logout      - ç”¨æˆ·ç™»å‡º
```

---

### 2. å¥½å‹æ¨¡å— (Friendship Module)

**åŠŸèƒ½ï¼š** å¥½å‹å…³ç³»ç®¡ç†

**æ ¸å¿ƒç±»ï¼š**
- `Friendship` - å¥½å‹å…³ç³»å®ä½“
- `FriendshipService` - å¥½å‹æœåŠ¡æ¥å£
- `FriendshipServiceImpl` - å¥½å‹æœåŠ¡å®ç°
- `FriendshipController` - å¥½å‹æ§åˆ¶å™¨
- `FriendshipCacheService` - å¥½å‹ç¼“å­˜æœåŠ¡

**ä¸»è¦åŠŸèƒ½ï¼š**
- âœ… æ·»åŠ /åˆ é™¤å¥½å‹
- âœ… å¥½å‹å¤‡æ³¨/åˆ†ç»„
- âœ… æ‹‰é»‘/å–æ¶ˆæ‹‰é»‘
- âœ… å¥½å‹åˆ—è¡¨æŸ¥è¯¢
- âœ… å¥½å‹æœç´¢

**æ•°æ®å­˜å‚¨ï¼š**
- MySQL `friendship` è¡¨ - å¥½å‹å…³ç³»
- Redis - å¥½å‹åˆ—è¡¨ç¼“å­˜

**API ç¤ºä¾‹ï¼š**
```
POST   /api/friend/add           - æ·»åŠ å¥½å‹
DELETE /api/friend/{friendId}    - åˆ é™¤å¥½å‹
GET    /api/friend/list          - è·å–å¥½å‹åˆ—è¡¨
POST   /api/friend/block/{id}    - æ‹‰é»‘å¥½å‹
```

---

### 3. ç¾¤ç»„æ¨¡å— (Group Module)

**åŠŸèƒ½ï¼š** ç¾¤ç»„ç®¡ç†

**æ ¸å¿ƒç±»ï¼š**
- `Group` - ç¾¤ç»„å®ä½“
- `GroupMember` - ç¾¤æˆå‘˜å®ä½“
- `GroupService` - ç¾¤ç»„æœåŠ¡æ¥å£
- `GroupServiceImpl` - ç¾¤ç»„æœåŠ¡å®ç°
- `GroupController` - ç¾¤ç»„æ§åˆ¶å™¨
- `GroupCacheService` - ç¾¤ç»„ç¼“å­˜æœåŠ¡

**ä¸»è¦åŠŸèƒ½ï¼š**
- âœ… åˆ›å»º/è§£æ•£ç¾¤ç»„
- âœ… åŠ å…¥/é€€å‡ºç¾¤ç»„
- âœ… è¸¢å‡ºæˆå‘˜
- âœ… è®¾ç½®ç®¡ç†å‘˜
- âœ… ç¦è¨€ç®¡ç†
- âœ… è½¬è®©ç¾¤ä¸»
- âœ… ç¾¤ä¿¡æ¯ç®¡ç†

**æ•°æ®å­˜å‚¨ï¼š**
- MySQL `group` è¡¨ - ç¾¤ç»„ä¿¡æ¯
- MySQL `group_member` è¡¨ - ç¾¤æˆå‘˜å…³ç³»
- Redis - ç¾¤ç»„ä¿¡æ¯ç¼“å­˜ã€æˆå‘˜åˆ—è¡¨ç¼“å­˜

**API ç¤ºä¾‹ï¼š**
```
POST   /api/group/create         - åˆ›å»ºç¾¤ç»„
POST   /api/group/{id}/join      - åŠ å…¥ç¾¤ç»„
POST   /api/group/{id}/quit      - é€€å‡ºç¾¤ç»„
GET    /api/group/{id}           - è·å–ç¾¤ä¿¡æ¯
GET    /api/group/list           - è·å–ç¾¤ç»„åˆ—è¡¨
```

---

### 4. æ¶ˆæ¯æ¨¡å— (Message Module)

**åŠŸèƒ½ï¼š** æ¶ˆæ¯æ”¶å‘å’Œç®¡ç†

**æ ¸å¿ƒç±»ï¼š**
- `Message` - æ¶ˆæ¯å®ä½“ï¼ˆMongoDBï¼‰
- `MessageService` - æ¶ˆæ¯æœåŠ¡æ¥å£
- `MessageServiceImpl` - æ¶ˆæ¯æœåŠ¡å®ç°
- `MessageController` - æ¶ˆæ¯æ§åˆ¶å™¨
- `MessageCacheService` - æ¶ˆæ¯ç¼“å­˜æœåŠ¡
- `MessageProducer` - æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆRocketMQï¼‰
- `MessageConsumer` - æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆRocketMQï¼‰

**ä¸»è¦åŠŸèƒ½ï¼š**
- âœ… å‘é€æ¶ˆæ¯ï¼ˆå•èŠ/ç¾¤èŠï¼‰
- âœ… æ¶ˆæ¯æ’¤å›
- âœ… æ¶ˆæ¯åˆ é™¤
- âœ… æ¶ˆæ¯å·²è¯»/æœªè¯»
- âœ… æ¶ˆæ¯å†å²æŸ¥è¯¢
- âœ… æ¶ˆæ¯æœç´¢
- âœ… ç¦»çº¿æ¶ˆæ¯æ¨é€

**æ¶ˆæ¯ç±»å‹ï¼š**
- æ–‡æœ¬æ¶ˆæ¯ (TEXT = 1)
- å›¾ç‰‡æ¶ˆæ¯ (IMAGE = 2)
- è¯­éŸ³æ¶ˆæ¯ (VOICE = 3)
- è§†é¢‘æ¶ˆæ¯ (VIDEO = 4)
- æ–‡ä»¶æ¶ˆæ¯ (FILE = 5)

**æ•°æ®å­˜å‚¨ï¼š**
- MongoDB `message` é›†åˆ - æ¶ˆæ¯å†…å®¹
- MongoDB `offline_messages` é›†åˆ - ç¦»çº¿æ¶ˆæ¯
- Redis - æ¶ˆæ¯ç¼“å­˜ã€æœªè¯»æ•°ç¼“å­˜
- RocketMQ - æ¶ˆæ¯é˜Ÿåˆ—

**æ¶ˆæ¯æµç¨‹ï¼š**
```
å‘é€è€… â†’ MessageController â†’ MessageService 
    â†’ ä¿å­˜åˆ° MongoDB 
    â†’ å‘é€åˆ° RocketMQ 
    â†’ MessageConsumer æ¶ˆè´¹ 
    â†’ ConnectionService æ¨é€ 
    â†’ æ¥æ”¶è€…
```

**API ç¤ºä¾‹ï¼š**
```
POST   /api/message/send                    - å‘é€æ¶ˆæ¯
POST   /api/message/recall/{messageId}      - æ’¤å›æ¶ˆæ¯
GET    /api/message/chat/{targetUserId}     - è·å–å•èŠå†å²
GET    /api/message/group/{groupId}         - è·å–ç¾¤èŠå†å²
POST   /api/message/read/{messageId}        - æ ‡è®°å·²è¯»
```

---

### 5. æ–‡ä»¶æ¨¡å— (File Module)

**åŠŸèƒ½ï¼š** æ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†

**æ ¸å¿ƒç±»ï¼š**
- `FileMetadata` - æ–‡ä»¶å…ƒæ•°æ®å®ä½“
- `FileService` - æ–‡ä»¶æœåŠ¡æ¥å£
- `FileServiceImpl` - æ–‡ä»¶æœåŠ¡å®ç°
- `FileCacheService` - æ–‡ä»¶ç¼“å­˜æœåŠ¡

**ä¸»è¦åŠŸèƒ½ï¼š**
- âœ… æ–‡ä»¶ä¸Šä¼ 
- âœ… å›¾ç‰‡ä¸Šä¼ 
- âœ… è¯­éŸ³ä¸Šä¼ 
- âœ… è§†é¢‘ä¸Šä¼ 
- âœ… æ–‡ä»¶åˆ é™¤
- âœ… æ–‡ä»¶URLè·å–

**æ•°æ®å­˜å‚¨ï¼š**
- MySQL `file` è¡¨ - æ–‡ä»¶å…ƒæ•°æ®
- æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ/OSS - æ–‡ä»¶å­˜å‚¨
- Redis - æ–‡ä»¶URLç¼“å­˜

---

### 6. è¿æ¥ç®¡ç†æ¨¡å— (Connection Module)

**åŠŸèƒ½ï¼š** WebSocket è¿æ¥ç®¡ç†

**æ ¸å¿ƒç±»ï¼š**
- `ConnectionService` - è¿æ¥æœåŠ¡æ¥å£
- `ConnectionServiceImpl` - è¿æ¥æœåŠ¡å®ç°
- `WebSocketHandler` - WebSocket å¤„ç†å™¨
- `WebSocketConfig` - WebSocket é…ç½®
- `ConnectionCacheService` - è¿æ¥ç¼“å­˜æœåŠ¡

**ä¸»è¦åŠŸèƒ½ï¼š**
- âœ… ç”¨æˆ·ä¸Šçº¿/ä¸‹çº¿ç®¡ç†
- âœ… åœ¨çº¿çŠ¶æ€æŸ¥è¯¢
- âœ… æ¶ˆæ¯æ¨é€ï¼ˆå•æ’­/ç¾¤æ’­/å¹¿æ’­ï¼‰
- âœ… ä¼šè¯ç®¡ç†
- âœ… å¿ƒè·³æ£€æµ‹

**è¿æ¥æµç¨‹ï¼š**
```
å®¢æˆ·ç«¯ â†’ WebSocket è¿æ¥ (/ws)
    â†’ OpenResty JWT è®¤è¯
    â†’ WebSocketHandler å¤„ç†
    â†’ ConnectionService æ³¨å†Œä¼šè¯
    â†’ Redis å­˜å‚¨åœ¨çº¿çŠ¶æ€
```

---

## ğŸ—„ï¸ æ•°æ®å­˜å‚¨è®¾è®¡

### MySQL æ•°æ®åº“ (å…³ç³»å‹æ•°æ®)

**è¡¨ç»“æ„ï¼š**

1. **user** - ç”¨æˆ·è¡¨
   - å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
   - å­—æ®µï¼šid, username, password, nickname, avatar, phone, email, etc.

2. **friendship** - å¥½å‹å…³ç³»è¡¨
   - å­˜å‚¨å¥½å‹å…³ç³»
   - å­—æ®µï¼šid, user_id, friend_id, remark, status

3. **group** - ç¾¤ç»„è¡¨
   - å­˜å‚¨ç¾¤ç»„ä¿¡æ¯
   - å­—æ®µï¼šid, name, avatar, description, owner_id, max_member_count

4. **group_member** - ç¾¤æˆå‘˜è¡¨
   - å­˜å‚¨ç¾¤æˆå‘˜å…³ç³»
   - å­—æ®µï¼šid, group_id, user_id, role, mute_status

5. **conversation** - ä¼šè¯è¡¨
   - å­˜å‚¨ç”¨æˆ·ä¼šè¯åˆ—è¡¨
   - å­—æ®µï¼šid, conversation_id, type, owner_id, target_id, unread_count

6. **file** - æ–‡ä»¶å…ƒæ•°æ®è¡¨
   - å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
   - å­—æ®µï¼šid, file_name, file_type, file_size, file_path

### MongoDB æ•°æ®åº“ (æ–‡æ¡£å‹æ•°æ®)

**é›†åˆï¼š**

1. **message** - æ¶ˆæ¯é›†åˆ
   - å­˜å‚¨æ‰€æœ‰æ¶ˆæ¯å†…å®¹
   - å­—æ®µï¼šid, messageType, contentType, senderId, receiverId, groupId, content, sendTime

2. **offline_messages** - ç¦»çº¿æ¶ˆæ¯é›†åˆ
   - å­˜å‚¨ç¦»çº¿æ¶ˆæ¯
   - å­—æ®µï¼šuserId, messages[]

3. **mailboxes** - é‚®ç®±é›†åˆ
   - å­˜å‚¨æ¶ˆæ¯åºåˆ—å·
   - å­—æ®µï¼šuserId, sequence

### Redis ç¼“å­˜ (å†…å­˜æ•°æ®)

**ç¼“å­˜é”®è®¾è®¡ï¼š**

```
ç”¨æˆ·ç›¸å…³ï¼š
- user:info:{userId}           - ç”¨æˆ·ä¿¡æ¯
- user:token:{userId}          - ç”¨æˆ·Token
- user:online:{userId}         - åœ¨çº¿çŠ¶æ€
- user:session:{userId}        - ç”¨æˆ·ä¼šè¯

å¥½å‹ç›¸å…³ï¼š
- friend:list:{userId}         - å¥½å‹åˆ—è¡¨
- friend:relation:{userId}:{friendId} - å¥½å‹å…³ç³»

ç¾¤ç»„ç›¸å…³ï¼š
- group:info:{groupId}         - ç¾¤ç»„ä¿¡æ¯
- group:members:{groupId}      - ç¾¤æˆå‘˜åˆ—è¡¨
- user:groups:{userId}         - ç”¨æˆ·çš„ç¾¤ç»„åˆ—è¡¨

æ¶ˆæ¯ç›¸å…³ï¼š
- message:{messageId}          - æ¶ˆæ¯å†…å®¹
- message:unread:{userId}      - æœªè¯»æ¶ˆæ¯æ•°
- conversation:{userId}:{targetId} - ä¼šè¯æœ€æ–°æ¶ˆæ¯

æ–‡ä»¶ç›¸å…³ï¼š
- file:metadata:{fileId}       - æ–‡ä»¶å…ƒæ•°æ®
- file:url:{fileId}            - æ–‡ä»¶URL
```

---

## ğŸ”„ æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡ (RocketMQ)

**Topic è®¾è®¡ï¼š**

```
im-message-topic           - æ¶ˆæ¯ä¸»é¢˜
  â”œâ”€ CHAT (Tag)           - èŠå¤©æ¶ˆæ¯
  â”œâ”€ SYSTEM (Tag)         - ç³»ç»Ÿæ¶ˆæ¯
  â””â”€ NOTIFICATION (Tag)   - é€šçŸ¥æ¶ˆæ¯
```

**æ¶ˆæ¯æµè½¬ï¼š**

1. **å‘é€æ¶ˆæ¯**
   ```
   ç”¨æˆ·A â†’ MessageService.sendMessage()
       â†’ ä¿å­˜åˆ° MongoDB
       â†’ MessageProducer.sendMessage("im-message-topic", message)
       â†’ RocketMQ Broker
   ```

2. **æ¶ˆè´¹æ¶ˆæ¯**
   ```
   RocketMQ Broker â†’ MessageConsumer.onMessage()
       â†’ è§£ææ¶ˆæ¯
       â†’ ConnectionService.pushToUser() æ¨é€ç»™åœ¨çº¿ç”¨æˆ·
       â†’ æˆ–å­˜å‚¨åˆ°ç¦»çº¿æ¶ˆæ¯è¡¨
   ```

---

## ğŸŒ ç½‘å…³å±‚è®¾è®¡ (OpenResty)

**Lua è„šæœ¬åŠŸèƒ½ï¼š**

1. **auth.lua** - JWT è®¤è¯
   - éªŒè¯ Authorization å¤´
   - è§£æ JWT Token
   - æ£€æŸ¥ Token é»‘åå•ï¼ˆRedisï¼‰
   - è®¾ç½®ç”¨æˆ·IDåˆ°è¯·æ±‚å¤´

2. **limit.lua** - é™æµæ§åˆ¶
   - åŸºäºç”¨æˆ·IDæˆ–IPé™æµ
   - ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•
   - æ¯ç§’10ä¸ªè¯·æ±‚ï¼Œçªå‘20ä¸ª

3. **websocket_handler.lua** - WebSocket å¤„ç†
   - å»ºç«‹ WebSocket è¿æ¥
   - æ¶ˆæ¯è½¬å‘
   - å¿ƒè·³æ£€æµ‹

**Nginx é…ç½®ï¼š**
```nginx
location /api/ {
    access_by_lua_file /lua/limit.lua;
    access_by_lua_file /lua/auth.lua;
    proxy_pass http://im_backend;
}

location /ws {
    access_by_lua_file /lua/auth.lua;
    content_by_lua_file /lua/websocket_handler.lua;
}
```

---

## ğŸ” å®‰å…¨è®¾è®¡

### 1. è®¤è¯æœºåˆ¶
- **JWT Token** - æ— çŠ¶æ€è®¤è¯
- **Token è¿‡æœŸæ—¶é—´** - 7å¤©ï¼ˆå¯é…ç½®ï¼‰
- **Token åˆ·æ–°** - æ”¯æŒåˆ·æ–°æœºåˆ¶
- **Token é»‘åå•** - Redis å­˜å‚¨å·²æ’¤é”€çš„ Token

### 2. å¯†ç å®‰å…¨
- **BCrypt åŠ å¯†** - å¯†ç åŠ å¯†å­˜å‚¨
- **åŠ ç›å¤„ç†** - é˜²æ­¢å½©è™¹è¡¨æ”»å‡»
- **å¯†ç å¼ºåº¦æ ¡éªŒ** - å‰ç«¯+åç«¯åŒé‡æ ¡éªŒ

### 3. æ¥å£å®‰å…¨
- **é™æµ** - OpenResty é™æµ
- **é˜²é‡æ”¾** - æ—¶é—´æˆ³+ç­¾å
- **å‚æ•°æ ¡éªŒ** - @Valid æ³¨è§£æ ¡éªŒ
- **SQL æ³¨å…¥é˜²æŠ¤** - MyBatis å‚æ•°åŒ–æŸ¥è¯¢

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### Docker Compose éƒ¨ç½²

```yaml
services:
  mysql:       # ç«¯å£ 3306
  mongodb:     # ç«¯å£ 27017
  redis:       # ç«¯å£ 6379
  rocketmq-namesrv:  # ç«¯å£ 9876
  rocketmq-broker:   # ç«¯å£ 10909, 10911
  im-openresty:      # ç«¯å£ 80, 9001
  app:         # ç«¯å£ 8080
```

**å¯åŠ¨é¡ºåºï¼š**
1. åŸºç¡€è®¾æ–½ï¼ˆMySQL, MongoDB, Redis, RocketMQï¼‰
2. åº”ç”¨æœåŠ¡ï¼ˆSpring Bootï¼‰
3. ç½‘å…³æœåŠ¡ï¼ˆOpenRestyï¼‰

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥
- **ç”¨æˆ·ä¿¡æ¯** - 1å°æ—¶è¿‡æœŸ
- **å¥½å‹åˆ—è¡¨** - 30åˆ†é’Ÿè¿‡æœŸ
- **ç¾¤ç»„ä¿¡æ¯** - 30åˆ†é’Ÿè¿‡æœŸ
- **æ¶ˆæ¯å†…å®¹** - 10åˆ†é’Ÿè¿‡æœŸ

### 2. æ•°æ®åº“ä¼˜åŒ–
- **ç´¢å¼•è®¾è®¡** - ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µå»ºç´¢å¼•
- **åˆ†é¡µæŸ¥è¯¢** - é¿å…å…¨è¡¨æ‰«æ
- **è¯»å†™åˆ†ç¦»** - ä¸»ä»å¤åˆ¶ï¼ˆå¯é€‰ï¼‰

### 3. æ¶ˆæ¯é˜Ÿåˆ—ä¼˜åŒ–
- **æ‰¹é‡å‘é€** - å‡å°‘ç½‘ç»œå¼€é”€
- **å¼‚æ­¥å¤„ç†** - æé«˜å“åº”é€Ÿåº¦
- **æ¶ˆæ¯å‹ç¼©** - å‡å°‘ä¼ è¾“å¤§å°

---

## ğŸ¯ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. ç”¨æˆ·ç™»å½•æµç¨‹
```
1. ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç 
2. UserController.login() æ¥æ”¶è¯·æ±‚
3. UserService éªŒè¯ç”¨æˆ·åå¯†ç 
4. JwtUtils ç”Ÿæˆ Token
5. UserCacheService ç¼“å­˜ç”¨æˆ·ä¿¡æ¯å’Œ Token
6. è¿”å› UserLoginVOï¼ˆåŒ…å« Tokenï¼‰
```

### 2. å‘é€æ¶ˆæ¯æµç¨‹
```
1. ç”¨æˆ·Aå‘é€æ¶ˆæ¯ç»™ç”¨æˆ·B
2. MessageController.sendMessage() æ¥æ”¶è¯·æ±‚
3. MessageService æ„å»ºæ¶ˆæ¯å¯¹è±¡
4. ä¿å­˜æ¶ˆæ¯åˆ° MongoDB
5. MessageProducer å‘é€åˆ° RocketMQ
6. MessageConsumer æ¶ˆè´¹æ¶ˆæ¯
7. ConnectionService æ£€æŸ¥ç”¨æˆ·Bæ˜¯å¦åœ¨çº¿
8. å¦‚æœåœ¨çº¿ï¼šé€šè¿‡ WebSocket æ¨é€
9. å¦‚æœç¦»çº¿ï¼šå­˜å‚¨åˆ°ç¦»çº¿æ¶ˆæ¯è¡¨
```

### 3. åˆ›å»ºç¾¤ç»„æµç¨‹
```
1. ç”¨æˆ·Aåˆ›å»ºç¾¤ç»„
2. GroupController.createGroup() æ¥æ”¶è¯·æ±‚
3. GroupService åˆ›å»ºç¾¤ç»„è®°å½•
4. æ·»åŠ ç¾¤ä¸»ä¸ºæˆå‘˜ï¼ˆrole=2ï¼‰
5. æ·»åŠ åˆå§‹æˆå‘˜ï¼ˆå¦‚æœæœ‰ï¼‰
6. GroupCacheService ç¼“å­˜ç¾¤ç»„ä¿¡æ¯
7. è¿”å› GroupVO
```

---

## ğŸ“ å¾…å®ç°åŠŸèƒ½

- [ ] æ¶ˆæ¯åŠ å¯†
- [ ] æ•æ„Ÿè¯è¿‡æ»¤
- [ ] éŸ³è§†é¢‘é€šè¯
- [ ] æœ‹å‹åœˆåŠŸèƒ½
- [ ] çº¢åŒ…åŠŸèƒ½
- [ ] æ¶ˆæ¯å·²è¯»å›æ‰§
- [ ] ç¾¤ç»„@åŠŸèƒ½
- [ ] æ¶ˆæ¯è½¬å‘

---

## ğŸ”§ å¼€å‘å»ºè®®

1. **å…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½** - ç”¨æˆ·ã€å¥½å‹ã€ç¾¤ç»„ã€æ¶ˆæ¯
2. **é€æ­¥å®Œå–„ç»†èŠ‚** - ç¼“å­˜ã€å¼‚å¸¸å¤„ç†ã€æ—¥å¿—
3. **ç¼–å†™å•å…ƒæµ‹è¯•** - ä¿è¯ä»£ç è´¨é‡
4. **æ€§èƒ½æµ‹è¯•** - JMeter å‹åŠ›æµ‹è¯•
5. **å‰ç«¯å¯¹æ¥** - Vue + Ant Design

---

è¿™å°±æ˜¯ä½ çš„ Fleets IM ç³»ç»Ÿçš„å®Œæ•´æ¶æ„ï¼ç°åœ¨æ¸…æ¥šäº†å—ï¼ŸğŸ˜Š
