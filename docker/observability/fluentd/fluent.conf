# Fluentd配置文件

# 输入源：监听文件变化
<source>
  @type tail
  path /var/log/fleets/fleets-json.log
  pos_file /var/log/fleets/fleets-json.log.pos
  tag fleets.app
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  read_from_head true
</source>

# 输入源：监听错误日志
<source>
  @type tail
  path /var/log/fleets/fleets-error.log
  pos_file /var/log/fleets/fleets-error.log.pos
  tag fleets.error
  <parse>
    @type multiline
    format_firstline /^\d{4}-\d{2}-\d{2}/
    format1 /^(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}) \[(?<thread>[^\]]+)\] (?<level>\S+)\s+(?<logger>\S+) - (?<message>.*)/
  </parse>
  read_from_head true
</source>

# 过滤器：添加主机名和标签
<filter fleets.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    app "fleets"
    env "dev"
  </record>
</filter>

# 过滤器：解析日志级别
<filter fleets.**>
  @type record_transformer
  enable_ruby true
  <record>
    severity ${record["level"] || "INFO"}
  </record>
</filter>

# 输出到Loki
<match fleets.**>
  @type loki
  url http://loki:3100
  extra_labels {"app":"fleets","env":"dev"}
  <label>
    level
    logger
    thread
  </label>
  <buffer>
    @type file
    path /var/log/fluentd-buffers/loki.buffer
    flush_mode interval
    flush_interval 10s
    flush_at_shutdown true
    retry_type exponential_backoff
    retry_wait 1s
    retry_max_interval 60s
    retry_timeout 1h
  </buffer>
</match>

# 输出到标准输出（调试用）
<match fleets.debug>
  @type stdout
</match>
